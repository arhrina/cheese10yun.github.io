<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="nofollow">
    <meta name="google-site-verification" content="sBAfGubPxv1ol5QEVGgOJ4ggp5spK-zFFXpK-Pd2xZM">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Yun Blog | 기술 블로그">
    <meta name="keyword" content="Node NodeJs Spring Spring Boot Javascript">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <meta property="fb:app_id" content="175938796225834">
    <meta name="naver-site-verification" content="577f124124c409aa149a9b0163eca296de5d4533">

    <meta property="og:type" content="blog">
    <meta property="og:title" content="Spring Batch Test 작성 방법 및 고찰 - Yun Blog | 기술 블로그">
    <meta property="og:url" content="https://cheese10yun.github.io/spring-batch-test-2/">
    <meta property="og:description" content="Spring Batch Test 작성 방법 및 고찰 - Yun Blog | 기술 블로그">
    <meta property="og:image" content="">
    <script data-ad-client="ca-pub-5813739623204880" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script async custom-element="amp-ad" src="https://cdn.ampproject.org/v0/amp-ad-0.1.js"></script>




    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <link rel="canonical" href="https://cheese10yun.github.io/spring-batch-test-2/">


    <title>
        
          Spring Batch Test 작성 방법 및 고찰 - Yun Blog | 기술 블로그
        
    </title>

    <link rel="canonical" href="https://cheese10yun.github.io/spring-batch-test-2/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('https://i.imgur.com/avC1Xor.jpg')
            /*post*/
        
    }
    
    #signature{
        background-image: url('/img/signature/BeanTechSign-white.png');
    }
    
</style>

<header class="intro-header">


    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Test" title="Test">Test</a>
                            
                              <a class="tag" href="/tags/#Spring Batch" title="Spring Batch">Spring Batch</a>
                            
                        </div>
                        <h1>Spring Batch Test 작성 방법 및 고찰</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Yun on
                            2021-02-14
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Yun Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1><span id="spring-batch-test-code">Spring Batch Test Code</span></h1>
<p>스프링 배치 애플리케이션 테스트 코드를 작성하면서 만났던 이슈와 그에 따른 나름의 고찰을 정리한 포스팅 내용입니다. 배치를 사용하지 않더라도 스프링 기반으로 테스트를 작성하는 경우에도 도움 되는 내용들이 있습니다.</p>
<h2><span id="springbatchtest">@SpringBatchTest</span></h2>
<p><a href="https://docs.spring.io/spring-batch/docs/4.1.x/reference/html/whatsnew.html" rel="external nofollow noopener noreferrer" target="_blank">Spring Batch 4.1</a> 버전 부터는 <code>@SpringBatchTest</code> Annotation을 지원합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBatchTest</span></span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = &#123;JobConfiguration.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobLauncherTestUtils jobLauncherTestUtils;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobRepositoryTestUtils jobRepositoryTestUtils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearMetadata</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        jobRepositoryTestUtils.removeJobExecutions();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// given</span></span><br><span class="line">        JobParameters jobParameters =</span><br><span class="line">            jobLauncherTestUtils.getUniqueJobParameters();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// when</span></span><br><span class="line">        JobExecution jobExecution =</span><br><span class="line">            jobLauncherTestUtils.launchJob(jobParameters);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// then</span></span><br><span class="line">        Assert.assertEquals(ExitStatus.COMPLETED,</span><br><span class="line">            jobExecution.getExitStatus());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>JobLauncherTestUtils : 스프링 배치 테스트에 필요한 유틸 기능</li>
<li>JobRepositoryTestUtils : 데이터베이스에 저장된 JobExcution을 생성/삭제 지원</li>
<li>StepScopeTestExecutionListener : 배치 단위 테스트 시 StepScope 컨텍스트를 생성, 해당 컨텍스트를 통해 JobParamerter 등을 단위 테스트에서 DI 받을 수 있음</li>
<li>JobSopceTestExecutionListener : 배치 단위 테스트 시 JobScope 컨텍스트를 생성, 해당 컨텍스트를 통해 JobParameter 등을 단위 테스트에서 DI 받을 수 있음</li>
</ul>
<p><code>@SpringBatchTest</code>으로 위 코드를 자동으로 구성할 수 있습니다.</p>
<h2><span id="spring-batch-test-support-만들기">Spring Batch Test Support 만들기</span></h2>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@SpringBatchTest</span></span><br><span class="line"><span class="meta">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="meta">@ActiveProfiles(<span class="meta-string">"test"</span>)</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchTestSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> entityManagerFactory: EntityManagerFactory</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> jobLauncherTestUtils: JobLauncherTestUtils</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">val</span> entityManager <span class="keyword">by</span> lazy &#123; entityManagerFactory.createEntityManager() &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">var</span> jobExecution: JobExecution? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">val</span> query: JPAQueryFactory <span class="keyword">by</span> lazy &#123; JPAQueryFactory(entityManager) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">launchJob</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        job: <span class="type">Job</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobParameters: <span class="type">JobParameters</span> = jobLauncherTestUtils.uniqueJobParameters</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        jobLauncherTestUtils.job = job</span><br><span class="line">        <span class="keyword">this</span>.jobExecution = jobLauncherTestUtils.launchJob(jobParameters)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">launchStep</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        stepName: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobParameters: <span class="type">JobParameters</span> = jobLauncherTestUtils.uniqueJobParameters,</span></span></span><br><span class="line"><span class="function"><span class="params">        executionContext: <span class="type">ExecutionContext</span>? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.jobExecution = jobLauncherTestUtils.launchStep(stepName, jobParameters, executionContext)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">thenBatchCompleted</span><span class="params">()</span></span> &#123;</span><br><span class="line">        then(BatchStatus.COMPLETED).isEqualTo(jobExecution?.status)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">thenBatchStatus</span><span class="params">(batchStatus: <span class="type">BatchStatus</span>)</span></span> &#123;</span><br><span class="line">        then(batchStatus).isEqualTo(jobExecution?.status)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">save</span><span class="params">(entity: <span class="type">T</span>)</span></span>: T &#123;</span><br><span class="line">        entityManager.transaction.let &#123; transaction -&gt;</span><br><span class="line">            transaction.begin()</span><br><span class="line">            entityManager.persist(entity)</span><br><span class="line">            transaction.commit()</span><br><span class="line">            entityManager.clear()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> entity</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">saveAll</span><span class="params">(entities: <span class="type">List</span>&lt;<span class="type">T</span>&gt;)</span></span>: List&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> entityManager = entityManagerFactory.createEntityManager()</span><br><span class="line">        entityManager.transaction.let &#123; transaction -&gt;</span><br><span class="line">            transaction.begin()</span><br><span class="line">            <span class="keyword">for</span> (entity <span class="keyword">in</span> entities) &#123;</span><br><span class="line">                entityManager.persist(entity)</span><br><span class="line">            &#125;</span><br><span class="line">            transaction.commit()</span><br><span class="line">            entityManager.clear()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> entities</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;E&gt;</span> List<span class="type">&lt;E&gt;</span>.<span class="title">persist</span><span class="params">()</span></span> &#123;</span><br><span class="line">        saveAll(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">deleteAll</span><span class="params">(path: <span class="type">EntityPath</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">        entityManager.transaction.let &#123; transaction -&gt;</span><br><span class="line">            transaction.begin()</span><br><span class="line">            query.delete(path).execute()</span><br><span class="line">            transaction.commit()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>배치 애플리케이션의 테스트를 도와주는 유틸성 클래스, 테스트 코드를 효율적으로 작성할 수 있게 지원합니다. 어떤 기능들이 있고, 이 기능들이 어떤 불편한 점 때문에 추가했는지에 대해서 설명을 진행하겠습니다.</p>
<h3><span id="테스트-job-실행은">테스트 Job 실행은?</span></h3>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchTestSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> jobLauncherTestUtils: JobLauncherTestUtils</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">launchJob</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        job: <span class="type">Job</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobParameters: <span class="type">JobParameters</span> = jobLauncherTestUtils.uniqueJobParameters</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        jobLauncherTestUtils.job = job</span><br><span class="line">        <span class="keyword">this</span>.jobExecution = jobLauncherTestUtils.launchJob(jobParameters)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvWriterConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> csvWriterJob: Job,</span><br><span class="line">) : BatchTestSupport() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvWriterJob test`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//given</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        launchJob(csvWriterJob)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//then</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> jobLauncherTestUtils: JobLauncherTestUtils</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvWriterJob test 슈퍼 클래스에 없는 경우 직접 DI 받아 job을 실헹 해야한다`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//given</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        jobLauncherTestUtils.job = job</span><br><span class="line">        jobLauncherTestUtils.launchJob(job)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//then</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>배치 테스트를 위해서는 Job을 실행시켜야 합니다. 이것을 편리하게 도와주는 것이 <code>launchJob()</code>메서드입니다. <code>JobLauncherTestUtils</code>의 <code>launchJob()</code> 메서드를 한 번 감싸서 사용하는 용도로 특별하건 없습니다. 슈퍼 클래스에서 의존성을 주입받지 않으면 실제 테스트에 계속 DI를 받아 사용해야 하기 때문에 슈퍼 클래스에서 해당 기능을 제공합니다. JobParameters가 필요한 경우 <code>JobParameters</code>를 전달하면 됩니다. 그렇지 않은 경우에는 스프링 배치에서 자체적으로 유니크한 <code>JobParameters</code>을 생성하는 기본값을 지정했습니다.</p>
<h3><span id="특정-step만-테스트하고-싶은-경우는">특정 Step만 테스트하고 싶은 경우는 ?</span></h3>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sampleJob</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    jobBuilderFactory: <span class="type">JobBuilderFactory</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    step1: <span class="type">Step</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    step2: <span class="type">Step</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    step3: <span class="type">Step</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    step4: <span class="type">Step</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    step5: <span class="type">Step</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>: Job =</span><br><span class="line">    jobBuilderFactory[<span class="string">"csvWriterJob"</span>]</span><br><span class="line">        .incrementer(RunIdIncrementer())</span><br><span class="line">        .listener(JobReportListener())</span><br><span class="line">        .start(step1)</span><br><span class="line">        .next(step2)</span><br><span class="line">        .next(step3)</span><br><span class="line">        .next(step4)</span><br><span class="line">        .next(step5)</span><br><span class="line">        .build()</span><br></pre></td></tr></table></figure>
<p>단순한 Job의 경우에는 Step이 여러개로 구성되어 있는 경우는 특정 Step만 테스트를 진행하는 단위 테스트가 필요할 수 있습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchTestSupport</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">launchStep</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        job: <span class="type">Job</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        stepName: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobParameters: <span class="type">JobParameters</span> = jobLauncherTestUtils.uniqueJobParameters,</span></span></span><br><span class="line"><span class="function"><span class="params">        executionContext: <span class="type">ExecutionContext</span>? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.jobExecution = jobLauncherTestUtils.launchStep(stepName, jobParameters, executionContext)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvWriterConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> csvWriterJob: Job,</span><br><span class="line">) : BatchTestSupport() &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvWriterStep test`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//given</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        launchStep(csvWriterJob, <span class="string">"csvWriterStep"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//then</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step 테스트도 마찬가지로 <code>jobLauncherTestUtils.launchStep()</code> 메서드를 활용해서 특정 Step을 실행할 수 있습니다. 개인적으로는 <code>launchStep()</code> 테스트를 진행하는 것은 좋아하지는 않습니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/batch-study/docs/img/ste-test-1.png" alt=""></p>
<p>Job name이 <code>name=TestJob</code> 이것을 확인할 수 있습니다. Step을 테스트하기 위해서는 반드시 Job이 있어야 하기 때문에 <code>TestJob</code>으로 연결해서 테스트를 진행하는 것입니다. 이렇게 테스트가 진행되게 되면 문제가 있을 수 있습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleJobListener</span> : <span class="type">JobExecutionListener &#123;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log <span class="keyword">by</span> logger()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">beforeJob</span><span class="params">(jobExecution: <span class="type">JobExecution</span>)</span></span> &#123;</span><br><span class="line">        log.info(<span class="string">"beforeJob"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">afterJob</span><span class="params">(jobExecution: <span class="type">JobExecution</span>)</span></span> &#123;</span><br><span class="line">        log.info(<span class="string">"afterJob"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CsvWriterJobConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">csvWriterJob</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        jobBuilderFactory: <span class="type">JobBuilderFactory</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        csvWriterStep: <span class="type">Step</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: Job =</span><br><span class="line">        jobBuilderFactory[<span class="string">"csvWriterJob"</span>]</span><br><span class="line">            .incrementer(RunIdIncrementer())</span><br><span class="line">            .listener(SimpleJobListener())</span><br><span class="line">            .start(csvWriterStep)</span><br><span class="line">            .build()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드처럼 <code>SimpleJobListener</code>로 Job 시작 이전, 이후로 log를 찍는 리스너를 추가하고 <code>launchStep(&quot;csvWriterStep&quot;)</code> Step을 실행시키면 리스너는 동작하지 않습니다. 반면 <code>launchJob(csvWriterJob)</code>은 잘 동작합니다.</p>
<blockquote>
<p>launchJob(csvWriterJob) Log<br>
<img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/batch-study/docs/img/ste-test-2.png" alt=""></p>
</blockquote>
<blockquote>
<p>launchStep(“csvWriterStep”) Log<br>
<img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/batch-study/docs/img/ste-test-3.png" alt=""></p>
</blockquote>
<p>리스너는 Job에 연결이 된다는 것이지 Step에 연결돼있는 것은 아니며, 위에서 언급했듯 <code>launchStep()</code>은 <code>name=TestJob</code>으로 Job을 실행시키기 때문에 해당 잡에는 리스너가 없어 당연한 결과입니다.</p>
<p>해당 코드는 단순하게 리스너로 로직을 것이지만 해당 Step에 필요한 리스너라면 예상했던 테스트 결과와 다르게 동작할 수 있습니다. 이러한 문제 때문에 저는 아래와 같은 방식으로 Step 테스트합니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvWriterConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> csvWriterJob: Job,</span><br><span class="line">    csvWriterStep: Step,</span><br><span class="line">    jobBuilderFactory: JobBuilderFactory,</span><br><span class="line">) : BatchTestSupport() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> job = jobBuilderFactory[<span class="string">"csvWriterStepForTestJob"</span>]</span><br><span class="line">        .incrementer(RunIdIncrementer())</span><br><span class="line">        .listener(SimpleJobListener())</span><br><span class="line">        .start(csvWriterStep)</span><br><span class="line">        .build()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvWriterStep job을 직접 생성해서 테스트`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//given</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        launchJob(job)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//then</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드는 실제 Job을 생성하고 해당 Job으로 <code>launchJob()</code>메서드를 통해서 Job을 실행시키고 있습니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/batch-study/docs/img/ste-test-4.png" alt=""><br>
해당 결과 리스너의 로그 및 Job name이 <code>name=csvWriterStepForTestJob</code>으로 테스트를 진행하는 것을 확인할 수 있습니다.</p>
<p>그 밖에도 Job을 직접 생성할 수 있으니 다양한 방법으로 테스트를 진행할 수 있습니다. 예를 들어 특정 step 몇 개를 연결해서 단위 테스트해볼 수 있으며, Flow와 같은 배치 Step의 순서에 대한 Flow를 직접 정의해서 테스트할 수 있습니다.</p>
<h3><span id="테스트-데이터-세팅은">테스트 데이터 세팅은?</span></h3>
<p>배치 애플리케이션 여러 여러 테이블의 데이터를 읽어 오고, 여러 테이블에 데이터를 저장하는 경우가 빈번합니다. 이런 경우 테스트를 작성하기 위한 <code>given</code>절에 해당하는 데이터 세팅이 많이 번거롭습니다.</p>
<h3><span id="jpa-기반-세팅">JPA 기반 세팅</span></h3>
<p>테스트를 진행할 때 <code>given</code>을 JPA 기반으로 작성하기 위해서는 <code>Repositroy</code>를 주입받아 save 해서 테스트하는 것이 일반적입니다. 위에서도 언급했지만 여러 테이블의 조회가 필요하니 그 필요한 테이블만큼 <code>Repositroy</code>를 주입 받아야 하는데 이것이 생각보다 귀찮고 코딩의 흐름을 방해합니다.</p>
<p>테스트 코드를 작성하다 ‘아 데이터가 필요하네…’ 하고 다시 테스트 클래스 상위로 올라가 필요한 Repositroy를 주입받고 다시 save를 진행하는 것은 코딩의 흐름을 많이 방해한다고 생각합니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchTestSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> entityManagerFactory: EntityManagerFactory</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">val</span> entityManager <span class="keyword">by</span> lazy &#123; entityManagerFactory.createEntityManager() &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">save</span><span class="params">(entity: <span class="type">T</span>)</span></span>: T &#123;</span><br><span class="line">        entityManager.transaction.let &#123; transaction -&gt;</span><br><span class="line">            transaction.begin()</span><br><span class="line">            entityManager.persist(entity)</span><br><span class="line">            transaction.commit()</span><br><span class="line">            entityManager.clear()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> entity</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">saveAll</span><span class="params">(entities: <span class="type">List</span>&lt;<span class="type">T</span>&gt;)</span></span>: List&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> entityManager = entityManagerFactory.createEntityManager()</span><br><span class="line">        entityManager.transaction.let &#123; transaction -&gt;</span><br><span class="line">            transaction.begin()</span><br><span class="line">            <span class="keyword">for</span> (entity <span class="keyword">in</span> entities) &#123;</span><br><span class="line">                entityManager.persist(entity)</span><br><span class="line">            &#125;</span><br><span class="line">            transaction.commit()</span><br><span class="line">            entityManager.clear()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> entities</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위에서 언급한 문제를 해결하기 위해서 <code>BatchTestSupport</code>는 해당 기능을 제공합니다. <code>EntityManagerFactory</code>를 주입받아 <code>EntityManager</code>를 직접 생성하여 해당 매니저로 트랜잭션을 진행시켜 필요한 데이터를 세팅합니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvWriterConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> csvWriterJob: Job,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paymentRepository: PaymentRepository</span><br><span class="line">    ...</span><br><span class="line">) : BatchTestSupport() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span> </span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvWriterJob repositroy를 DI 받아 테스트 진행`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//given</span></span><br><span class="line">        (<span class="number">1.</span><span class="number">.10</span>).map &#123;</span><br><span class="line">            Payment(</span><br><span class="line">                amount = it.toBigDecimal(),</span><br><span class="line">                orderId = it.toLong()</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">            .also &#123;</span><br><span class="line">                paymentRepository.saveAll(it)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        launchJob(csvWriterJob)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//then</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvWriterJob test`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//given</span></span><br><span class="line">        (<span class="number">1.</span><span class="number">.10</span>).map &#123;</span><br><span class="line">            Payment(</span><br><span class="line">                amount = it.toBigDecimal(),</span><br><span class="line">                orderId = it.toLong()</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">            .persist()</span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        launchJob(csvWriterJob)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//then</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>위 테스트 코드는 Repositroy를 주입받아 테스트, <code>BatchTestSupport</code>를 기반으로 테스트하는 코드입니다. 해당 코드는 단순하지만 테스트에 필요한 <code>Repositroy</code>가 많아지면 <code>BatchTestSupport</code> 기반으로 테스트하는 것이 효율적입니다.</p>
<h3><span id="sql-기반-세팅">SQL 기반 세팅</span></h3>
<p>프로젝트가 JPA 기반으로 진행하고 있다면 코드 냥이 많아 지나더라도 JPA 기반으로 테스트하는 것이 장기적으로 좋다고 생각한다. 하지만 JPA로 데이터 셋업이 번거롭고, 특정 시점으로 데이터를 Set Up 하기에는 어려운 부분이 있다. 그런 경우 유용한 방법이 <code>@Sql</code>을 기반으로 데이터를 세팅하는 것이다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> payment (amount, order_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="number">100</span>, <span class="number">1</span>),</span><br><span class="line">       ...</span><br><span class="line">       (<span class="number">100</span>, <span class="number">1</span>),</span><br><span class="line">       (<span class="number">100</span>, <span class="number">1</span>)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Sql(<span class="meta-string">"/csv-setup.sql"</span>)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvWriterJob sql 테스트 진행`<span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//given</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//when</span></span><br><span class="line">    launchJob(csvWriterJob)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//then</span></span><br><span class="line">    thenBatchCompleted()</span><br><span class="line"></span><br><span class="line">    deleteAll(QPayment.payment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>/test/resources/csv-setup.sql</code> 해당 경로에 SQL 파일을 위치시키고 <code>@Sql</code>으로 해당 경로를 지정하면 해당 SQL 기반으로 데이터를 세팅합니다. <code>@Sql</code>는 테스트 메서드 단위로 실행되기 때문에 편리하지만 SQL의 단순 문자열 기반으로 관리되기 때문에 엔티티가 변경되는 경우 유지 보수가 어려운 부분들이 있습니다. <strong>해당 엔티티가 변경될 일이 거의 없거나. 데이터의 특정 시점을 객체 기반으로 만들기 어려운 경우 사용하는 것을 권장합니다.</strong></p>
<h3><span id="테스트-검증은">테스트 검증은?</span></h3>
<p>테스트 검증 시 여러 테이블에 대한 변경 작업이 발생했을 경우 모든 변경에 대한 테스트를 작성해야 합니다. 우선 then에서 검증할 엔티티의 개수만큼 <code>Repositroy</code>를 주입받아야 합니다. 이는 위에서도 언급했듯이 코딩의 흐름에 악영향을 미칩니다. 무엇보다 테스트 검증을 위한 조회를 <code>Repositroy</code>를 의존하게 되면 <strong>오직 테스트 코드 검증을 위한 조회 로직이 필요하게 됩니다.</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvWriterJob 테스트 코드만을 위한 코드`<span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//given</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//when</span></span><br><span class="line">    launchJob(csvWriterJob)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//then</span></span><br><span class="line">    thenBatchCompleted()</span><br><span class="line">    paymentRepository.findByxxxxx() <span class="comment">// 오직 테스트 코드엑서만 사용한다</span></span><br><span class="line"></span><br><span class="line">    deleteAll(QPayment.payment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 테스트의 검증은 paymentRepository 기반으로 진행하고 있습니다. 그런데 검증을 위해 조회 코드가 없어 만들려고 하는데 <strong>이 코드는 오직 테스트 검증 시에만 사용하게 되는 코드입니다. 이렇게 테스트를 위해서 특정 메서드가 테스트 스코프가 아닌 영역에 있다는 거 자체가 좋지 않은 패턴, 설계라고 생각합니다.</strong></p>
<p>이렇게 어려운 부분들을 해결하기 위해서 Query DSL 기반으로 조회를 진행할 수 있는 <code>JPAQueryFactory</code>를 <code>BatchTestSupport</code>에서 지원하고 있습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvReaderJobConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> csvReaderJob: Job,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paymentRepository: PaymentRepository</span><br><span class="line">) : BatchTestSupport() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvReaderJob repository 기반 테스트`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//given</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        launchJob(csvReaderJob)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//then</span></span><br><span class="line">        thenBatchCompleted()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> payments = paymentRepository.findByOrderId(<span class="number">1</span>L)</span><br><span class="line"></span><br><span class="line">        then(payments).hasSize(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">        deleteAll(QPayment.payment)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `csvReaderJob JPAQueryFactory 기반 테스트`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//given</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        launchJob(csvReaderJob)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//then</span></span><br><span class="line">        thenBatchCompleted()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> payments = query.selectFrom(QPayment.payment)</span><br><span class="line">            .where(QPayment.payment.orderId.eq(<span class="number">1</span>L))</span><br><span class="line">            .fetch()</span><br><span class="line"></span><br><span class="line">        then(payments).hasSize(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">        deleteAll(QPayment.payment)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>repository 기반으로 테스트 진행할 할 때, 당연하지만 해당 Repositroy를 주입받아야 하며 검증 조회 메서드가 없는 경우 오직 테스트 코드에서 사용하기 위해서 메서드를 구현해야 합니다. 검증할 엔티티가 많아지면 그만큼 위 작업을 반복해야 합니다.</p>
<p>JPAQueryFactory 기반으로 테스트는 Query DSL 방식으로 검증을 진행하기 때문에 불필요한 DI, 조회 검증 메서드는 테스트에서 직접 구현해서 이런 문제를 해결할 수 있습니다.</p>
<h3><span id="테스트-검증-이후-데이터-제거는">테스트 검증 이후 데이터 제거는 ?</span></h3>
<p>스프링 배치 애플리케이션은 <code>@Transactional</code>으로 시작할 수 없습니다. 그 결과 테스트 메서드가 끝난 이후에 <strong>자동으로 해당 데이터가 롤백 되지 않으며 데이터가 남아 있어 다른 테스트 코드에 영향을 주게 됩니다.</strong> 그러기 때문에 테스트가 끝난 이후에 데이터를 제거하는 작업을 해야 합니다. 반복적인 이야기이지만 Repositroy 기반으로 해당 작업을 하기 위해서는 의존성을 주입받아야 합니다. 이것들을 쉽게 처리할 수 있게 <code>BatchTestSupport</code>에서 <code>deleteAll()</code> 메서드를 지원합니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchTestSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> entityManagerFactory: EntityManagerFactory</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">val</span> entityManager <span class="keyword">by</span> lazy &#123; entityManagerFactory.createEntityManager() &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">deleteAll</span><span class="params">(path: <span class="type">EntityPath</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">        entityManager.transaction.let &#123; transaction -&gt;</span><br><span class="line">            transaction.begin()</span><br><span class="line">            query.delete(path).execute()</span><br><span class="line">            transaction.commit()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvReaderJobConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> csvReaderJob: Job</span><br><span class="line">) : BatchTestSupport() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">deleteAll</span><span class="params">()</span></span> &#123;</span><br><span class="line">        deleteAll(QPayment.payment)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BatchTestSupport</code>에서 엔티티 매니저를 직접 생성해서 <code>JPAQueryFactory</code> 기반으로 데이터를 제거합니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/batch-study/docs/img/delete-query.png" alt=""></p>
<p>실제 delete 쿼리가 동작하는 것을 확인할 수 있습니다.</p>
<h3><span id="왜-배치에서는-transactional을-물고-시작할-수-없을까">왜 배치에서는 @Transactional을 물고 시작할 수 없을까?</span></h3>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvReaderJobConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> csvReaderJob: Job</span><br><span class="line">) : BatchTestSupport() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">deleteAll</span><span class="params">()</span></span> &#123;</span><br><span class="line">        deleteAll(QPayment.payment)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `@Transactional 물고 시작하는 경우 테스트는 정상 동작하지 않습니다`<span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/batch-study/docs/img/transactional-test.png" alt=""></p>
<p>트랜잭션을 물고 시작하면 위와 같은 에러가 발생합니다. 일단 실패하는 것은 확인했고 그 이유에 대해서 정리해 해보겠습니다. 해당 내용은 제가 이해한 내용으로 설명한 드린 부분이기 때문에 맞지 않을 수도 있습니다. 비판적으로 읽어주세요.</p>
<blockquote>
<p><img src="https://docs.spring.io/spring-batch/docs/current/reference/html/images/meta-data-erd.png.pagespeed.ce.0yIgDTiutm.png" alt=""><br>
이미지 출처 <a href="https://docs.spring.io/spring-batch" rel="external nofollow noopener noreferrer" target="_blank">spring-batch</a></p>
</blockquote>
<p>스프링 배치에서는 배치에 대한 메타 정보를 저장하기 위해서 <a href="https://docs.spring.io/spring-batch/docs/current/reference/html/schema-appendix.html#metaDataSchema" rel="external nofollow noopener noreferrer" target="_blank">Meta-Data Schema</a>를 이용합니다. <strong>결과 적으로 해당 정보를 데이터베이스에 저장하기 위해서는 트랜잭잭션이 필요합니다.</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvReaderJobConfigurationTest</span></span>() &#123;...&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/batch-study/docs/img/spring-batch-transactional.png" alt=""></p>
<p>테스트 코드에서 트랜잭션을 물고 시작하면 위와 같은 트랜잭션 원자성이 하나로 묶이게 됩니다. 그렇다면 문제가 생겨서 롤백이 발생하면 어떻게 될까요? 하나의 원자성을 가지고 있기 때문에 <code>Meta-Data Schema</code>에 저장돼있는 데이터까지 모두 롤백 되게 됩니다. 해당 저장소에는 배치에 실패에 대한 기록도 남겨야 하기 때문에 이는 문제가 되기 때문에 이러한 경우 예외가 발생하는 것이라고 생각합니다.</p>
<h2><span id="그동안-배치-테스트를-작성하면서-느낀-점들">그동안 배치 테스트를 작성하면서 느낀 점들</span></h2>
<p>그동안 스프링 배치 테스트 코드 작성에 대한 나름의 고찰을 정리해 보았습니다. 배치 애플리케이션 테스트 코드도 다른 환경에서의 테스트 코드 작성 방식과 전체적인 방향성은 크게 다르지 않다고 생각합니다. 스프링 배치라는 프레임워크를 통해서 조금 더 쉽고 안전하게 테스트할 수 있는 방향성에 대해서 포스팅해보았습니다.</p>
<p>스프링 배치 프레임워크를 사용하기 때문에 테스트 코드 작성 시에도 제약사항을 받는 부분이 있었고 이를 원천적으로 해결하기에는 아직도 역량이 많이 부족하다는 생각이 들었습니다. 그래도 이러한 부분들에 대해서 정리가 저와 같은 고민을 했던 분들에게 조금이라도 도움이 되기를 기원하겠습니다. 긴 글 읽어주셔서 감사합니다.</p>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/jpa-batch-insert/" data-toggle="tooltip" data-placement="top" title="Batch Insert 성능 향상기 1편 - With JPA">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/spring-batch-application/" data-toggle="tooltip" data-placement="top" title="Spring Batch Application 개발하면서 나름의 고찰 정리">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Spring Batch Test Code</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">@SpringBatchTest</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">Spring Batch Test Support 만들기</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">테스트 Job 실행은?</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">특정 Step만 테스트하고 싶은 경우는 ?</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.3.</span> <span class="toc-nav-text">테스트 데이터 세팅은?</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.4.</span> <span class="toc-nav-text">JPA 기반 세팅</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.5.</span> <span class="toc-nav-text">SQL 기반 세팅</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.6.</span> <span class="toc-nav-text">테스트 검증은?</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.7.</span> <span class="toc-nav-text">테스트 검증 이후 데이터 제거는 ?</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.8.</span> <span class="toc-nav-text">왜 배치에서는 @Transactional을 물고 시작할 수 없을까?</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">그동안 배치 테스트를 작성하면서 느낀 점들</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Test" title="Test">Test</a>
                        
                          <a class="tag" href="/tags/#Spring Batch" title="Spring Batch">Spring Batch</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>



<!-- Comment -->
<!--  utteranc comment -->

<script src="https://utteranc.es/client.js" repo="cheese10yun/blog-comment" issue-term="title" label="Comment" theme="github-light" crossorigin="anonymous" async>
</script>






<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                

                

                

                
                    <li>
                        <a target="_blank" href="https://github.com/cheese10yun" rel="external nofollow noopener noreferrer">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Yun 2021 
                    <br>
                    Theme by <a href="http://huangxuan.me" rel="external nofollow noopener noreferrer" target="_blank">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://beantech.org" rel="external nofollow noopener noreferrer" target="_blank">BeanTech</a> | 
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=YenYuHsuan&repo=hexo-theme-beantech&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://cheese10yun.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-90907312-1';
    var _gaDomain = 'https://cheese10yun.github.io/';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->



	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async></script>
<!-- Image to hack wechat -->
<img src="https://cheese10yun.github.io/img/icon_wechat.png" width="0" height="0">
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
