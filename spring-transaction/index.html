<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="nofollow">
    <meta name="google-site-verification" content="sBAfGubPxv1ol5QEVGgOJ4ggp5spK-zFFXpK-Pd2xZM">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Yun Blog | 기술 블로그">
    <meta name="keyword" content="Node NodeJs Spring Spring Boot Javascript">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <meta property="fb:app_id" content="175938796225834">
    <meta name="naver-site-verification" content="577f124124c409aa149a9b0163eca296de5d4533">

    <meta property="og:type" content="blog">
    <meta property="og:title" content="Spring 레플리케이션 트랜잭션 처리 방식 - Yun Blog | 기술 블로그">
    <meta property="og:url" content="https://cheese10yun.github.io/spring-transaction/">
    <meta property="og:description" content="Spring 레플리케이션 트랜잭션 처리 방식 - Yun Blog | 기술 블로그">
    <meta property="og:image" content="">
    <script data-ad-client="ca-pub-5813739623204880" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script async custom-element="amp-ad" src="https://cdn.ampproject.org/v0/amp-ad-0.1.js"></script>




    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <link rel="canonical" href="https://cheese10yun.github.io/spring-transaction/">


    <title>
        
          Spring 레플리케이션 트랜잭션 처리 방식 - Yun Blog | 기술 블로그
        
    </title>

    <link rel="canonical" href="https://cheese10yun.github.io/spring-transaction/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('https://i.imgur.com/avC1Xor.jpg')
            /*post*/
        
    }
    
    #signature{
        background-image: url('/img/signature/BeanTechSign-white.png');
    }
    
</style>

<header class="intro-header">


    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Spring" title="Spring">Spring</a>
                            
                              <a class="tag" href="/tags/#Transaction" title="Transaction">Transaction</a>
                            
                        </div>
                        <h1>Spring 레플리케이션 트랜잭션 처리 방식</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Yun on
                            2021-05-08
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Yun Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>대부분의 서비스에서는 데이터베이스를 Master, Slave 구조로 Master에서는 Create, Update, Delete 업무를 진행하고 Slave에서 Read 업무를 진행하는 구조로 설계합니다. Spring의 Master, Slave 환경에서의 트랜잭션에 대해서 포스팅해보겠습니다.</p>
<h2><span id="레플리케이션">레플리케이션</span></h2>
<h3><span id="mysql-레플리케이션">MySQL 레플리케이션</span></h3>
<p><img src="https://github.com/cheese10yun/TIL/raw/master/assets/mysql-replication3.png" alt=""></p>
<p>MySQL은 위와 같은 구조로 마스터 - 슬레이브 구조를 지원합니다. 간략하게 설명하면 다음과 같이 구성되어 있습니다.</p>
<ul>
<li>마스터의 변경을 기록하기 위한 바이너리 로그</li>
<li>슬레이브에 데이터를 전송하기 위한 마스터 스레드</li>
<li>슬레이브에서 데이터를 받아 릴레이 로그에 기록하기 위한 I/O 스레드</li>
<li>릴레이 로그에서 데이터를 읽어 재생하기 위한 슬레이브 SQL 스레드</li>
</ul>
<p>MySQL 5.7부터 ACK를 기다리는 시점의 변경이 생겼습니다. 기존 COMMIT을 실행한 다음이 아니라 COMMIT을 실행하기 전에 ACK를 기다리도록 변경되었습니다. 이로 인해 마스터에서 COMMIT이 완료된 트랜잭션은 모두 슬레이브에 확실히 전달되게 되어서 무손실 레플리케이션을 보다 잘 지원하게 되었습니다. 자세한 내용은 <a href="http://www.yes24.com/Product/Goods/72270172?" rel="external nofollow noopener noreferrer" target="_blank">MySQL 5.7 완벽 분석</a>에 잘 설명되어 있습니다.</p>
<h3><span id="routingdatasource">RoutingDataSource</span></h3>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-transaction/docs/replication-flow.png" alt=""></p>
<p>트랜잭션에서 <code>readOnly</code> 설정을 기준으로 <code>false</code> 경우 Master DataSource, <code>true</code> 경우 Slave DataSource를 바라보게 설정할 수 있습니다. Master, Slave의 DataSource의 설정은 Spring Boot에서의 순정을 상태를 최대한 이용하려 했습니다. 본 포스팅은 DataSource 코드 구성을 다루는 아니기 때문에 해당 내용은 다른 자료를 보시는 것을 권장드립니다.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">    datasource:</span></span><br><span class="line"><span class="attr">        initialization-mode:</span> <span class="string">never</span></span><br><span class="line"><span class="attr">        master:</span></span><br><span class="line"><span class="attr">            hikari:</span></span><br><span class="line"><span class="attr">                jdbc-url:</span> <span class="attr">jdbc:mysql://localhost:3306/study?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;rewriteBatchedStatements=true&amp;logger=Slf4JLogger&amp;profileSQL=false&amp;maxQuerySizeToLog=100000</span></span><br><span class="line"><span class="attr">                username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">                password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">                driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line"><span class="attr">        slave:</span></span><br><span class="line"><span class="attr">            hikari:</span></span><br><span class="line"><span class="attr">                jdbc-url:</span> <span class="attr">jdbc:mysql://localhost:3307/study?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;rewriteBatchedStatements=true&amp;logger=Slf4JLogger&amp;profileSQL=false&amp;maxQuerySizeToLog=100000</span></span><br><span class="line"><span class="attr">                username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">                password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">                driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">const <span class="keyword">val</span> PROPERTIES = <span class="string">"spring.datasource.hikari"</span></span><br><span class="line">const <span class="keyword">val</span> MASTER_DATASOURCE = <span class="string">"masterDataSource"</span></span><br><span class="line">const <span class="keyword">val</span> SLAVE_DATASOURCE = <span class="string">"slaveDataSource"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = [MASTER_DATASOURCE])</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = <span class="meta-string">"spring.datasource.master.hikari"</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">masterDataSource</span><span class="params">()</span></span> =</span><br><span class="line">        DataSourceBuilder.create()</span><br><span class="line">            .type(HikariDataSource::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = [SLAVE_DATASOURCE])</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(<span class="meta-string">"spring.datasource.slave.hikari"</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">slaveDataSource</span><span class="params">()</span></span> =</span><br><span class="line">        DataSourceBuilder.create()</span><br><span class="line">            .type(HikariDataSource::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">            .build()</span><br><span class="line">            .apply &#123; <span class="keyword">this</span>.isReadOnly = <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(MASTER_DATASOURCE, SLAVE_DATASOURCE)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">routingDataSource</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@Qualifier(MASTER_DATASOURCE)</span> masterDataSource: <span class="type">DataSource</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@Qualifier(SLAVE_DATASOURCE)</span> slaveDataSource: <span class="type">DataSource</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: DataSource &#123;</span><br><span class="line">        <span class="keyword">val</span> routingDataSource = RoutingDataSource()</span><br><span class="line">        <span class="keyword">val</span> dataSources = hashMapOf&lt;Any, Any&gt;()</span><br><span class="line">        dataSources[<span class="string">"master"</span>] = masterDataSource</span><br><span class="line">        dataSources[<span class="string">"slave"</span>] = slaveDataSource</span><br><span class="line">        routingDataSource.setTargetDataSources(dataSources)</span><br><span class="line">        routingDataSource.setDefaultTargetDataSource(masterDataSource)</span><br><span class="line">        <span class="keyword">return</span> routingDataSource</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(<span class="meta-string">"routingDataSource"</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">dataSource</span><span class="params">(routingDataSource: <span class="type">DataSource</span>)</span></span> =</span><br><span class="line">        LazyConnectionDataSourceProxy(routingDataSource)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoutingDataSource</span> : <span class="type">AbstractRoutingDataSource</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">determineCurrentLookupKey</span><span class="params">()</span></span>: Any =</span><br><span class="line">        <span class="keyword">when</span> &#123;</span><br><span class="line">            TransactionSynchronizationManager.isCurrentTransactionReadOnly() -&gt; <span class="string">"slave"</span></span><br><span class="line">            <span class="keyword">else</span> -&gt; <span class="string">"master"</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>masterDataSource</code>, <code>routingDataSource</code> DataSource의 Bean을 설정합니다. 각각 3306(Master), 3307(Slave) 포트를 사용하며 해당 디비는 Master, Slave 설정까지 완료되어 있습니다.</p>
<p><code>routingDataSource</code>에서는 <code>masterDataSource</code>, <code>routingDataSource</code> 데이터 소스를 <code>master</code>, <code>slave</code>를 HashMap에 저장합니다. <code>determineCurrentLookupKey</code> 메서드에서 <code>readOnly</code> 설정 여부에 따라 <code>master</code>, <code>slave</code>의 <code>DataSource</code>를 선택하게 됩니다.</p>
<p>마지막으로 기본 <code>dataSource</code> Bean을 생성합니다. 이때 <code>routingDataSource</code> Bean을 이용해서 <code>LazyConnectionDataSourceProxy</code>를 생성합니다.</p>
<h3><span id="routingdatasource-테스트">RoutingDataSource 테스트</span></h3>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="meta-string">"/api/book"</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookApi</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bookRepository: BookRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="meta-string">"/slave"</span>)</span></span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getSlave</span><span class="params">()</span></span> = bookRepository.findAll()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="meta-string">"/master"</span>)</span></span><br><span class="line">    <span class="meta">@Transactional(readOnly = false)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getMaster</span><span class="params">()</span></span> = bookRepository.findAll()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>/api/book/slave</code>는 <code>readOnly = true</code> 설정으로 Slave를 바라보게 하고, 그와 반대로 <code>/api/book/master</code>는 <code>readOnly = false</code>설정으로 Master를 바라보게 설정하고 API 호출 이후 데이터베이스 로그를 확인해보겠습니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-transaction/docs/query-log.png" alt=""></p>
<p><code>readOnly</code> 여부에 따라서 DataSource가 적절하게 라우팅 되는 것을 확인할 수 있습니다.</p>
<h2><span id="spring-transaction-테스트">Spring Transaction 테스트</span></h2>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppSetup</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bookRepository: BookRepository</span><br><span class="line">) : ApplicationRunner &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">(args: <span class="type">ApplicationArguments</span>)</span></span> &#123;</span><br><span class="line">        bookRepository.saveAll(</span><br><span class="line">            (<span class="number">1.</span><span class="number">.5</span>).map &#123; Book(title = <span class="string">"INIT"</span>) &#125;</span><br><span class="line">                .toList()</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Application이 실행될 때 title이 <code>INIT</code>으로 데이터를 5개를 생성하는 코드를 추가했습니다. 각 메서드마다 <code>readOnly</code> 설정을 다루게 두고 업데이트 작업을 진행하게 됩니다.</p>
<h3><span id="조회-이후-업데이트">조회 이후 업데이트</span></h3>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="meta-string">"/api/book"</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookApi</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bookRepository: BookRepository,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bookService: BookService</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="meta-string">"/update/slave"</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">startSlave</span><span class="params">()</span></span> &#123;</span><br><span class="line">        bookService.updateSlave()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookService</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bookRepository: BookRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateSlave</span><span class="params">()</span></span> &#123;</span><br><span class="line">        updateTitle(<span class="string">"new title(slave)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(readOnly = false)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateMaster</span><span class="params">()</span></span> &#123;</span><br><span class="line">        updateTitle(<span class="string">"new title(master)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(readOnly = false)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateTitle</span><span class="params">(title: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> books = bookRepository.findAll()</span><br><span class="line">        <span class="keyword">for</span> (book <span class="keyword">in</span> books) &#123;</span><br><span class="line">            book.title = title</span><br><span class="line">        &#125;</span><br><span class="line">        bookRepository.saveAll(books)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>updateSlave()</code> 메서드는 <code>readOnly = true</code> 시작하고, <code>updateTitle()</code> 메서드에서 <code>readOnly = false</code>로 진행</li>
<li><code>updateMaster()</code> 메서드는 <code>readOnly = false</code> 시작하고, <code>updateTitle()</code> 메서드에서 <code>readOnly = false</code>로 진행</li>
</ul>
<h4><span id="slave-조회-이후-업데이트">slave 조회 이후 업데이트</span></h4>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-transaction/docs/query-log-update-in-slave.png" alt=""></p>
<p>select query가 slave에서 진행된 것을 확인할 수 있습니다. 조회는 <code>readOnly = true</code> 설정이지만 title를 업데이트할 때는 <code>readOnly = false</code>이기 때문에 영속성 컨텍스트가 flush를 진행하면 해당 내용이 데이터베이스에 반영될 까요? 확인해 보겠습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8080/api/book/master</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Thu, 06 May 2021 13:53:28 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;INIT&quot;,</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:42:33&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;INIT&quot;,</span><br><span class="line">    &quot;id&quot;: 2,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:42:33&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;INIT&quot;,</span><br><span class="line">    &quot;id&quot;: 3,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:42:33&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;INIT&quot;,</span><br><span class="line">    &quot;id&quot;: 4,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:42:33&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;INIT&quot;,</span><br><span class="line">    &quot;id&quot;: 5,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:42:33&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 31ms; Content length: 461 bytes</span><br></pre></td></tr></table></figure>
<p>결과는 변경되지 않았습니다.</p>
<h4><span id="master-조회-이후-업데이트">master 조회 이후 업데이트</span></h4>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-transaction/docs/master-update-result.png" alt=""></p>
<p>select, update query가 master에서 진행된 것을 확인할 수 있습니다. 마찬가지로 API를 호출해서 결과를 확인해 보겠습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8080/api/book/master</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Thu, 06 May 2021 14:01:40 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;new title(master)&quot;,</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:59:06&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;new title(master)&quot;,</span><br><span class="line">    &quot;id&quot;: 2,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:59:06&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;new title(master)&quot;,</span><br><span class="line">    &quot;id&quot;: 3,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:59:06&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;new title(master)&quot;,</span><br><span class="line">    &quot;id&quot;: 4,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:59:06&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;new title(master)&quot;,</span><br><span class="line">    &quot;id&quot;: 5,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-06T22:42:33&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-06T22:59:06&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 51ms; Content length: 526 bytes</span><br></pre></td></tr></table></figure>
<p>정상적으로 title이 변경된 것을 확인할 수 있습니다.</p>
<h4><span id="다른-트랜잭션에서-update">다른 트랜잭션에서 Update</span></h4>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookService</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bookRepository: BookRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateSlave</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">"updateSlave CurrentTransactionName: <span class="subst">$&#123;TransactionSynchronizationManager.getCurrentTransactionName()&#125;</span>"</span>)</span><br><span class="line">        bookUpdateService.updateTitle(<span class="string">"new title(slave)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookUpdateService</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bookRepository: BookRepository</span><br><span class="line">)&#123;</span><br><span class="line">    <span class="meta">@Transactional(readOnly = false, propagation = Propagation.REQUIRES_NEW)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateTitle</span><span class="params">(title: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">"updateTitle CurrentTransactionName: <span class="subst">$&#123;TransactionSynchronizationManager.getCurrentTransactionName()&#125;</span>"</span>)</span><br><span class="line">        <span class="keyword">val</span> books = bookRepository.findAll()</span><br><span class="line">        <span class="keyword">for</span> (book <span class="keyword">in</span> books) &#123;</span><br><span class="line">            book.title = title</span><br><span class="line">        &#125;</span><br><span class="line">        bookRepository.saveAll(books)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BookUpdateService 클래스를 만들고 <code>updateTitle</code> 메서드를 해당 클래스에서 <code>propagation = Propagation.REQUIRES_NEW</code> 설정을 통해서 새로운 트랜잭션에서 처리하도록 작성하고 <code>/api/book/update/slave</code>를 호출하고 조회 API를 호출해서 결과를 확인해 보겠습니다.</p>
<p>기존 서비스 코드에서 구현을 하지 않고 BookUpdateService 서비스 코드를 만든 이유는 동일한 Bean에서 <code>@Transactional</code>예상하는 것과 다르게 동작하기 때문입니다. 자세한 내용은 이전 동일한 <a href="https://cheese10yun.github.io/spring-transacion-same-bean/">Bean(Class)에서 @Transactional 동작 방식</a>을 참고해 주세요</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8080/api/book/slave</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Sat, 08 May 2021 12:38:56 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;title&quot;: &quot;new title(slave)&quot;,</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2021-05-08T21:37:43&quot;,</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2021-05-08T21:38:44&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 107ms; Content length: 521 bytes</span><br></pre></td></tr></table></figure>
<p>새로운 트랜잭션의 경우 <code>masterDataSource</code>를 바라보게 되며 데이터베이스에 반영되는것을 확인할 수 있습니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-transaction/docs/transaction-name.png" alt=""></p>
<p>트랜잭션 이름을 봐도 해당 트랜잭션이 다르다는 것을 확인할 수 있습니다. 즉 <code>com.example.springtransaction.BookService.updateSlave</code> 트랜잭션은 <code>salveDataSoruce</code>, <code>com.example.springtransaction.BookUpdateService.updateTitle</code>는 <code>masterDataSource</code>를 바라봅니다.</p>
<h2><span id="그렇다면-왜-그런것일까">그렇다면 왜 그런것일까?</span></h2>
<p><strong>첫 트랜잭션의 설정의 <code>readOnly</code>에 따라 <code>salveDataSoruce</code>, <code>masterDataSource</code>가 결정되며, 동일한 트랜잭션에서는 지정된 <code>readOnly</code> 속성은 변경되지 않습니다.</strong> 기존 트랜잭션과 전혀 다른 트랜잭션을 만나게 되면 해당 트랜잭션의 <code>readOnly</code>설정에 따라 <code>DataSource</code>가 결정됩니다. 그렇다면 왜 이렇게 되는 걸까요? <strong>제가 학습했던 내용을 토대로 설명드리기 때문에 틀린 부분이 있을 수도 있습니다.</strong></p>
<h3><span id="스프링의-트랜잭션-동기화">스프링의 트랜잭션 동기화</span></h3>
<blockquote>
<p><img src="https://raw.githubusercontent.com/cheese10yun/TIL/master/assets/TransactionSynchronizations.png" alt=""><br>
<a href="http://m.yes24.com/goods/detail/7516911" rel="external nofollow noopener noreferrer" target="_blank">토비의 스프링 3.1, 361 페이지</a></p>
</blockquote>
<p>스프링은 위와 같은 방식으로 트랜잭션 동기화를 진행합니다. 해당 방식은 트랜잭션을 시작하기 위해 만든 Connection 오브젝트를 특별한 저장소에 보관해두고, 이후에 호출되는 메서드에서 저장된 Connection을 가져다가 사용합니다.</p>
<ul>
<li><code>(1)</code> Userservice Connection을 생성</li>
<li><code>(2)</code> 생성된 Connection을 트랜잭션 동기화 저장소에 저장, SetAutoCommit(false)를 호출하여 트랜잭션을 시작</li>
<li><code>(3)</code> 첫 번째 <code>update()</code> 메서드가 호출되고 <strong><code>(4)</code> 트랜잭션 동기화 저장소에 현재 시작된 트랜잭션을 가진 Connection을 확인합니다. 이 경우는<code>(2)</code>에서 생성한 Connection을 가져옵니다.</strong></li>
<li><code>(5)</code> Connection을 이용해 PreparedsStatment을 만들어 해당 SQL을 실행하고 <strong>JdbcTemplated는 Connection 닫지 않은 상태로 작업을 마침</strong></li>
<li>동일한 플로우로 <code>(6)</code>, <code>(7)</code>, <code>(8)</code> 수행</li>
<li>또 동일한 플로우로 <code>(9)</code>, <code>(10)</code>, <code>(11)</code> 수행하며 <strong>트랜잭션 내의 모든 작업이 정상적으로 끝났으면 <code>(12)</code> Conntion commit을 호출해 트랜잭션을 완료</strong></li>
<li><code>(13)</code> 트랜잭션 저장소가 더 이상 Connection 객체를 저장하지 않도록 이를 제거</li>
</ul>
<p>위와 같은 플로우로 트랜잭션이 진행됩니다.</p>
<blockquote>
<p><code>updateSlave()</code> 메서드는 <code>readOnly = true</code> 시작하고, <code>updateTitle()</code> 메서드에서 <code>readOnly = false</code>로 진행 되는 경우</p>
</blockquote>
<p>이런 경우에는 <code>updateSlave()</code>에서 Connection(Slave)을 생성 하고 <strong><code>updateTitle()</code>에서 트랜잭션 동기화 저장소에 저장된 트랜잭션을 가진 Connection(Slave) 기반으로 트랜잭션을 시작하게 됩니다.</strong> 그러기 때문에 <code>updateTitle()</code> 메서드의 트랜잭션 <code>readOnly = false</code> 설정은 동작하지 않게 됩니다.</p>
<h2><span id="참고">참고</span></h2>
<ul>
<li><a href="http://www.yes24.com/Product/Goods/72270172?" rel="external nofollow noopener noreferrer" target="_blank">MySQL 5.7 완벽 분석</a></li>
<li><a href="https://taes-k.github.io/2020/03/11/sprinig-master-slave-dynamic-routing-datasource/" rel="external nofollow noopener noreferrer" target="_blank">Spring, master-slave dynamic routing datasource 사용하기</a></li>
<li><a href="http://m.yes24.com/goods/detail/7516911" rel="external nofollow noopener noreferrer" target="_blank">토비의 스프링 3.1</a></li>
</ul>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/exposed/" data-toggle="tooltip" data-placement="top" title="Exposed">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/spring-kotlin/" data-toggle="tooltip" data-placement="top" title="Kotlin으로 Spring 개발할 때">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">레플리케이션</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">MySQL 레플리케이션</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">RoutingDataSource</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">RoutingDataSource 테스트</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Spring Transaction 테스트</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">조회 이후 업데이트</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.1.1.</span> <span class="toc-nav-text">slave 조회 이후 업데이트</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.1.2.</span> <span class="toc-nav-text">master 조회 이후 업데이트</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.1.3.</span> <span class="toc-nav-text">다른 트랜잭션에서 Update</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">그렇다면 왜 그런것일까?</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">스프링의 트랜잭션 동기화</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">참고</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Spring" title="Spring">Spring</a>
                        
                          <a class="tag" href="/tags/#Transaction" title="Transaction">Transaction</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>



<!-- Comment -->
<!--  utteranc comment -->

<script src="https://utteranc.es/client.js" repo="cheese10yun/blog-comment" issue-term="title" label="Comment" theme="github-light" crossorigin="anonymous" async>
</script>






<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                

                

                

                
                    <li>
                        <a target="_blank" href="https://github.com/cheese10yun" rel="external nofollow noopener noreferrer">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Yun 2021 
                    <br>
                    Theme by <a href="http://huangxuan.me" rel="external nofollow noopener noreferrer" target="_blank">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://beantech.org" rel="external nofollow noopener noreferrer" target="_blank">BeanTech</a> | 
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=YenYuHsuan&repo=hexo-theme-beantech&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://cheese10yun.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-90907312-1';
    var _gaDomain = 'https://cheese10yun.github.io/';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->



	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async></script>
<!-- Image to hack wechat -->
<img src="https://cheese10yun.github.io/img/icon_wechat.png" width="0" height="0">
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
