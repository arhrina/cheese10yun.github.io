<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="nofollow">
    <meta name="google-site-verification" content="sBAfGubPxv1ol5QEVGgOJ4ggp5spK-zFFXpK-Pd2xZM">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Yun Blog | 기술 블로그">
    <meta name="keyword" content="Node NodeJs Spring Spring Boot Javascript">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <meta property="fb:app_id" content="175938796225834">
    <meta name="naver-site-verification" content="577f124124c409aa149a9b0163eca296de5d4533">

    <meta property="og:type" content="blog">
    <meta property="og:title" content="Batch Insert 성능 향상기 1편 - With JPA - Yun Blog | 기술 블로그">
    <meta property="og:url" content="https://cheese10yun.github.io/jpa-batch-insert/">
    <meta property="og:description" content="Batch Insert 성능 향상기 1편 - With JPA - Yun Blog | 기술 블로그">
    <meta property="og:image" content="">




    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <link rel="canonical" href="https://cheese10yun.github.io/jpa-batch-insert/">


    <title>
        
          Batch Insert 성능 향상기 1편 - With JPA - Yun Blog | 기술 블로그
        
    </title>

    <link rel="canonical" href="https://cheese10yun.github.io/jpa-batch-insert/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('https://i.imgur.com/avC1Xor.jpg')
            /*post*/
        
    }
    
    #signature{
        background-image: url('/img/signature/BeanTechSign-white.png');
    }
    
</style>

<header class="intro-header">
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#JPA" title="JPA">JPA</a>
                            
                              <a class="tag" href="/tags/#Batch Insert" title="Batch Insert">Batch Insert</a>
                            
                        </div>
                        <h1>Batch Insert 성능 향상기 1편 - With JPA</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Yun on
                            2021-02-22
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Yun Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>성능 향상을 위해서 Batch Insert를 도입하는 과정 중 JPA, Mysql 환경에서의 Batch Insert에 대한 방법과 제약사항들에 대해서 정리했습니다. 결과적으로는 다른 프레임워크를 도입해서 해결했으며 본 포스팅은 JPA Batch Insert의 정리와, 왜 다른 프레임워크를 도입을 했는지에 대해한 내용입니다.</p>
<h2><span id="batch-insert-란">Batch Insert 란 ?</span></h2>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 단건 insert</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (?, ?)</span><br><span class="line"></span><br><span class="line"># 멀티 <span class="keyword">insert</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id)</span><br><span class="line"><span class="keyword">values</span> </span><br><span class="line">       (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>insert rows 여러 개 연결해서 한 번에 입력하는 것을 Batch Insert라고 말합니다. 당연한 이야기이지만 Batch Insert는 하나의 트랜잭션으로 묶이게 됩니다.</p>
<h2><span id="batch-insert-with-jpa">Batch Insert With JPA</span></h2>
<p>위 Batch Insert SQL이 간단해 보이지만 실제 로직으로 작성하려면 코드가 복잡해지고 실수하기 좋은 포인트들이 있어 유지 보수하기 어려운 코드가 되기 쉽습니다. 해당 포인트들은 아래 주석으로 작성했습니다. <strong>JPA를 사용하면 이러한 문제들을 정말 쉽게 해결이 가능합니다.</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 문자열로 기반으로 SQL을 관리하기 때문에 변경 및 유지 보수에 좋지 않음</span></span><br><span class="line"><span class="keyword">val</span> sql = <span class="string">"insert into payment_back (id, amount, order_id) values (?, ?, ?)"</span></span><br><span class="line"><span class="keyword">val</span> statement = connection.prepareStatement(sql)!!</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">addBatch</span><span class="params">(payment: <span class="type">Payment</span>)</span></span> = statement.apply &#123;</span><br><span class="line">    <span class="comment">// code 바인딩 순서에 따라 오동작 가능성이 높음</span></span><br><span class="line">    <span class="comment">// 매번 자료형을 지정해서 값을 입력해야 함</span></span><br><span class="line">    <span class="keyword">this</span>.setLong(<span class="number">1</span>, payment.id!!)</span><br><span class="line">    <span class="keyword">this</span>.setBigDecimal(<span class="number">2</span>, payment.amount)</span><br><span class="line">    <span class="keyword">this</span>.setLong(<span class="number">3</span>, payment.orderId)</span><br><span class="line">    <span class="keyword">this</span>.addBatch()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connection &amp; statement 객체를 직접 close 진행, 하지 않을 경우 문제 발생 가능성이 있음</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (statement.isClosed.not())</span><br><span class="line">        statement.close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="쓰기-지연-sql-지원-이란">쓰기 지연 SQL 지원 이란 ?</span></h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">EntityMaanger em  = emf.createEnttiyManager();</span><br><span class="line">ENtityTranscation transaction = em.getTransaction();</span><br><span class="line"><span class="comment">// 엔티티 매니저는 데이터 변경 시 트랜잭션을 시작해야 한다.</span></span><br><span class="line"></span><br><span class="line">transaction.begin();</span><br><span class="line"></span><br><span class="line">em.persist(memberA);</span><br><span class="line">em.persist(memberB);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 여기까지 Insert SQL을 데이터베이스에 보내지 않는다.</span></span><br><span class="line"><span class="comment">// Commit을 하는 순간 데이터베이스에 Insert SQL을 보낸다</span></span><br><span class="line">transaction.commit();</span><br></pre></td></tr></table></figure>
<p>엔티티 매니저는 트랜잭션을 커밋 하기 직전까지 데이터베이스에 엔티티를 저장하지 않고 내부 쿼리 저장소에 INSERT SQL을 모아둔다. 그리고 트랜잭션을 커밋 할 때 모아둔 쿼리를 데이터베이스에 보내는데 이것을 트랜잭션을 지원하는 쓰기 지연이라 한다.</p>
<p><img src="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent.png" alt=""></p>
<p>회원 A를 영속화했다. 영속성 컨텍스트는 1차 캐시에 회원 엔티티를 저장하면서 동시에 회원 엔티티 정보로 등록 쿼리를 만든다. 그리고 만들어진 등록 쿼리를 쓰기 지연 SQL 저장소에 보관한다.</p>
<p><img src="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent-2.png" alt=""><br>
다음으로 회원 B를 영속화했다. 마찬가지로 회원 엔티티 정보로 등록 쿼리를 생성해서 쓰지 지연 SQL 저장소에 보관한다. 현재 쓰기 지연 SQL 저장소에는 등록 쿼리가 2건이 저장되어 있다.</p>
<p><img src="https://github.com/cheese10yun/TIL/raw/master/assets/jpa-insert-persistent-3.png" alt=""></p>
<p>마지막으로 트랜잭션을 커밋 했다. 트랜잭션을 커밋 하면 엔티티 매니저는 우선 영속성 컨텍스트를 플러시 한다. 플러시는 영속성 컨텍스트의 변경 내용을 데이터베이스에 동기화하는 작업인데 이때 등록, 수정, 삭제한 엔티티를 데이터베이스에 반영한다. <strong>이러한 부분은 JPA 내부적으로 이루어지기 때문에 사용하는 코드에서는 코드의 변경 없이 이러한 작업들이 가능하다.</strong></p>
<h3><span id="jpa-with-batch-insert-code">JPA With Batch Insert Code</span></h3>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">    jpa:</span></span><br><span class="line"><span class="attr">        database:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">        properties:</span></span><br><span class="line">            <span class="string">hibernate.jdbc.batch_size:</span> <span class="number">50</span></span><br><span class="line">            <span class="string">hibernate.order_inserts:</span> <span class="literal">true</span></span><br><span class="line">            <span class="string">hibernate.order_updates:</span> <span class="literal">true</span></span><br><span class="line">            <span class="string">hibernate.dialect:</span> <span class="string">org.hibernate.dialect.MySQL5InnoDBDialect</span></span><br><span class="line">            <span class="string">hibernate.show_sql:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    datasource:</span></span><br><span class="line"><span class="attr">        url:</span> <span class="attr">jdbc:mysql://localhost:3366/batch_study?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;rewriteBatchedStatements=true</span></span><br><span class="line"><span class="attr">        driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>
<p>addBatch 구분을 사용하기 위해서는 <code>rewriteBatchedStatements=true</code> 속성을 지정해야 합니다. 기본 설정은 <code>false</code>이며, 해당 설정이 없으면 Batch Insert는 동작하지 않습니다. 정확한 내용은 공식 문서를 참고해 주세요.</p>
<blockquote>
<p><a href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-performance-extensions.html" rel="external nofollow noopener noreferrer" target="_blank">MySQL Connector/J 8.0 Developer Guide : 6.3.13 Performance Extensions</a><br>
Stops checking if every INSERT statement contains the “ON DUPLICATE KEY UPDATE” clause. As a side effect, obtaining the statement’s generated keys information will return a list where normally it wouldn’t. Also be aware that, in this case, the list of generated keys returned may not be accurate. The effect of this property is canceled if set simultaneously with ‘rewriteBatchedStatements=true’.</p>
</blockquote>
<p><code>hibernate.jdbc.batch_size: 50</code> Batch Insert의 size를 지정합니다. 해당 크기에 따라서 한 번에 insert 되는 rows가 결정됩니다. 자세한 내용은 아래에서 설명드리겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = <span class="meta-string">"payment_back"</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentBackJpa</span></span>(</span><br><span class="line">    <span class="meta">@Column(name = <span class="meta-string">"amount"</span>, nullable = false)</span></span><br><span class="line">    <span class="keyword">var</span> amount: BigDecimal,</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = <span class="meta-string">"order_id"</span>, nullable = false, updatable = false)</span></span><br><span class="line">    <span class="keyword">val</span> orderId: <span class="built_in">Long</span></span><br><span class="line">)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@Column(name = <span class="meta-string">"id"</span>, updatable = false)</span> <span class="comment">// @GeneratedValue를 지정하지 않았음</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Long</span>? = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">PaymentBackJpaRepository</span>: <span class="type">JpaRepository</span>&lt;<span class="type">PaymentBackJpa, Long</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>엔티티 클래스는 간단합니다. 중요한 부분은 <code>@GeneratedValue</code>을 지정하지 않은 부분입니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">BulkInsertJobConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paymentBackJpaRepository: PaymentBackJpaRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `jpa 기반 bulk insert`<span class="params">()</span></span> &#123;</span><br><span class="line">        (<span class="number">1.</span><span class="number">.100</span>).map &#123;</span><br><span class="line">            PaymentBackJpa(</span><br><span class="line">                amount = it.toBigDecimal(),</span><br><span class="line">                orderId = it.toLong()</span><br><span class="line">            )</span><br><span class="line">                .apply &#123;</span><br><span class="line">                    <span class="keyword">this</span>.id = it.toLong() <span class="comment">// ID를 직접 지정</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;.also &#123;</span><br><span class="line">            paymentBackJpaRepository.saveAll(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>paymentBackJpaRepository.saveAll()</code>를 이용해서 batch inset를 진행합니다. JPA 기반으로 Batch Insert를 진행할 때 별다른 코드가 필요 없습니다. 컬렉션 객체를 <code>saveAll()</code>으로 저장하는 것이 전부입니다. <code>hibernate.show_sql: true</code>으로 로킹 결고를 확인해보겠습니다.</p>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/sql-batch-1.png" alt=""></p>
<p>로그상으로는 Batch Insert가 진행되지 않은 것처럼 보입니다. 결론부터 말씀드리면 실제로는 Batch Insert가 진행됐지만 <code>hibernate.show_sql: true</code> 기반 로그에는 제대로 표시가 되지 않습니다. Mysql의 실제 로그로 확인해보겠습니다.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show variables like 'general_log%'; # general_log 획인</span><br><span class="line">set global general_log = 'ON'; # `OFF` 경우 `ON` 으로 변경</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/cheese10yun/blog-sample/raw/master/batch-study/docs/img/sql-general.png" alt=""></p>
<p><strong>해당 로그 설정은 테스트, 개발 환경에서만 진행해야 합니다. 성능에 지장을 줄 수 있습니다.</strong> 해당 기능은 실시간으로 변경이 가능하기 때문에 바로 확인이 가능합니다. <code>/var/lib/mysql/0a651fe44d20.log</code> 파일에 로그를 확인할 수 있습니다.</p>
<h3><span id="batch-size">batch size</span></h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Query	<span class="keyword">SELECT</span> @@session.transaction_read_only</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id, <span class="keyword">id</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>),(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>),(<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>),(<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>),(<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>),(<span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>),(<span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>),(<span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>),(<span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>),(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>),(<span class="number">11</span>, <span class="number">11</span>, <span class="number">11</span>),(<span class="number">12</span>, <span class="number">12</span>, <span class="number">12</span>),(<span class="number">13</span>, <span class="number">13</span>, <span class="number">13</span>),(<span class="number">14</span>, <span class="number">14</span>, <span class="number">14</span>),(<span class="number">15</span>, <span class="number">15</span>, <span class="number">15</span>),(<span class="number">16</span>, <span class="number">16</span>, <span class="number">16</span>),(<span class="number">17</span>, <span class="number">17</span>, <span class="number">17</span>),(<span class="number">18</span>, <span class="number">18</span>, <span class="number">18</span>),(<span class="number">19</span>, <span class="number">19</span>, <span class="number">19</span>),(<span class="number">20</span>, <span class="number">20</span>, <span class="number">20</span>),(<span class="number">21</span>, <span class="number">21</span>, <span class="number">21</span>),(<span class="number">22</span>, <span class="number">22</span>, <span class="number">22</span>),(<span class="number">23</span>, <span class="number">23</span>, <span class="number">23</span>),(<span class="number">24</span>, <span class="number">24</span>, <span class="number">24</span>),(<span class="number">25</span>, <span class="number">25</span>, <span class="number">25</span>),(<span class="number">26</span>, <span class="number">26</span>, <span class="number">26</span>),(<span class="number">27</span>, <span class="number">27</span>, <span class="number">27</span>),(<span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>),(<span class="number">29</span>, <span class="number">29</span>, <span class="number">29</span>),(<span class="number">30</span>, <span class="number">30</span>, <span class="number">30</span>),(<span class="number">31</span>, <span class="number">31</span>, <span class="number">31</span>),(<span class="number">32</span>, <span class="number">32</span>, <span class="number">32</span>),(<span class="number">33</span>, <span class="number">33</span>, <span class="number">33</span>),(<span class="number">34</span>, <span class="number">34</span>, <span class="number">34</span>),(<span class="number">35</span>, <span class="number">35</span>, <span class="number">35</span>),(<span class="number">36</span>, <span class="number">36</span>, <span class="number">36</span>),(<span class="number">37</span>, <span class="number">37</span>, <span class="number">37</span>),(<span class="number">38</span>, <span class="number">38</span>, <span class="number">38</span>),(<span class="number">39</span>, <span class="number">39</span>, <span class="number">39</span>),(<span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>),(<span class="number">41</span>, <span class="number">41</span>, <span class="number">41</span>),(<span class="number">42</span>, <span class="number">42</span>, <span class="number">42</span>),(<span class="number">43</span>, <span class="number">43</span>, <span class="number">43</span>),(<span class="number">44</span>, <span class="number">44</span>, <span class="number">44</span>),(<span class="number">45</span>, <span class="number">45</span>, <span class="number">45</span>),(<span class="number">46</span>, <span class="number">46</span>, <span class="number">46</span>),(<span class="number">47</span>, <span class="number">47</span>, <span class="number">47</span>),(<span class="number">48</span>, <span class="number">48</span>, <span class="number">48</span>),(<span class="number">49</span>, <span class="number">49</span>, <span class="number">49</span>),(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@session.transaction_read_only</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id, <span class="keyword">id</span>) <span class="keyword">values</span> (<span class="number">51</span>, <span class="number">51</span>, <span class="number">51</span>),(<span class="number">52</span>, <span class="number">52</span>, <span class="number">52</span>),(<span class="number">53</span>, <span class="number">53</span>, <span class="number">53</span>),(<span class="number">54</span>, <span class="number">54</span>, <span class="number">54</span>),(<span class="number">55</span>, <span class="number">55</span>, <span class="number">55</span>),(<span class="number">56</span>, <span class="number">56</span>, <span class="number">56</span>),(<span class="number">57</span>, <span class="number">57</span>, <span class="number">57</span>),(<span class="number">58</span>, <span class="number">58</span>, <span class="number">58</span>),(<span class="number">59</span>, <span class="number">59</span>, <span class="number">59</span>),(<span class="number">60</span>, <span class="number">60</span>, <span class="number">60</span>),(<span class="number">61</span>, <span class="number">61</span>, <span class="number">61</span>),(<span class="number">62</span>, <span class="number">62</span>, <span class="number">62</span>),(<span class="number">63</span>, <span class="number">63</span>, <span class="number">63</span>),(<span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>),(<span class="number">65</span>, <span class="number">65</span>, <span class="number">65</span>),(<span class="number">66</span>, <span class="number">66</span>, <span class="number">66</span>),(<span class="number">67</span>, <span class="number">67</span>, <span class="number">67</span>),(<span class="number">68</span>, <span class="number">68</span>, <span class="number">68</span>),(<span class="number">69</span>, <span class="number">69</span>, <span class="number">69</span>),(<span class="number">70</span>, <span class="number">70</span>, <span class="number">70</span>),(<span class="number">71</span>, <span class="number">71</span>, <span class="number">71</span>),(<span class="number">72</span>, <span class="number">72</span>, <span class="number">72</span>),(<span class="number">73</span>, <span class="number">73</span>, <span class="number">73</span>),(<span class="number">74</span>, <span class="number">74</span>, <span class="number">74</span>),(<span class="number">75</span>, <span class="number">75</span>, <span class="number">75</span>),(<span class="number">76</span>, <span class="number">76</span>, <span class="number">76</span>),(<span class="number">77</span>, <span class="number">77</span>, <span class="number">77</span>),(<span class="number">78</span>, <span class="number">78</span>, <span class="number">78</span>),(<span class="number">79</span>, <span class="number">79</span>, <span class="number">79</span>),(<span class="number">80</span>, <span class="number">80</span>, <span class="number">80</span>),(<span class="number">81</span>, <span class="number">81</span>, <span class="number">81</span>),(<span class="number">82</span>, <span class="number">82</span>, <span class="number">82</span>),(<span class="number">83</span>, <span class="number">83</span>, <span class="number">83</span>),(<span class="number">84</span>, <span class="number">84</span>, <span class="number">84</span>),(<span class="number">85</span>, <span class="number">85</span>, <span class="number">85</span>),(<span class="number">86</span>, <span class="number">86</span>, <span class="number">86</span>),(<span class="number">87</span>, <span class="number">87</span>, <span class="number">87</span>),(<span class="number">88</span>, <span class="number">88</span>, <span class="number">88</span>),(<span class="number">89</span>, <span class="number">89</span>, <span class="number">89</span>),(<span class="number">90</span>, <span class="number">90</span>, <span class="number">90</span>),(<span class="number">91</span>, <span class="number">91</span>, <span class="number">91</span>),(<span class="number">92</span>, <span class="number">92</span>, <span class="number">92</span>),(<span class="number">93</span>, <span class="number">93</span>, <span class="number">93</span>),(<span class="number">94</span>, <span class="number">94</span>, <span class="number">94</span>),(<span class="number">95</span>, <span class="number">95</span>, <span class="number">95</span>),(<span class="number">96</span>, <span class="number">96</span>, <span class="number">96</span>),(<span class="number">97</span>, <span class="number">97</span>, <span class="number">97</span>),(<span class="number">98</span>, <span class="number">98</span>, <span class="number">98</span>),(<span class="number">99</span>, <span class="number">99</span>, <span class="number">99</span>),(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">commit</span></span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>실제 mysql 로그에서는 Batch Insert를 확인할 수 있습니다. 그런데 왜 2번에 걸쳐서 Batch Insert가 진행되었을까요? <strong><code>hibernate.jdbc.batch_size: 50</code>설정으로 Batch Insert에 대한 size를 50으로 지정했기 때문에 rows 100를 저장할 때 2번에 걸쳐 insert를 진행하는 것입니다.</strong> 만약 <code>hibernate.jdbc.batch_size: 100</code>이라면 1번의 insert로 저장됩니다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Query	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id, <span class="keyword">id</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>),(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>),(<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>),(<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>),(<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>),(<span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>),(<span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>),(<span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>),(<span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>),(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>),(<span class="number">11</span>, <span class="number">11</span>, <span class="number">11</span>),(<span class="number">12</span>, <span class="number">12</span>, <span class="number">12</span>),(<span class="number">13</span>, <span class="number">13</span>, <span class="number">13</span>),(<span class="number">14</span>, <span class="number">14</span>, <span class="number">14</span>),(<span class="number">15</span>, <span class="number">15</span>, <span class="number">15</span>),(<span class="number">16</span>, <span class="number">16</span>, <span class="number">16</span>),(<span class="number">17</span>, <span class="number">17</span>, <span class="number">17</span>),(<span class="number">18</span>, <span class="number">18</span>, <span class="number">18</span>),(<span class="number">19</span>, <span class="number">19</span>, <span class="number">19</span>),(<span class="number">20</span>, <span class="number">20</span>, <span class="number">20</span>),(<span class="number">21</span>, <span class="number">21</span>, <span class="number">21</span>),(<span class="number">22</span>, <span class="number">22</span>, <span class="number">22</span>),(<span class="number">23</span>, <span class="number">23</span>, <span class="number">23</span>),(<span class="number">24</span>, <span class="number">24</span>, <span class="number">24</span>),(<span class="number">25</span>, <span class="number">25</span>, <span class="number">25</span>),(<span class="number">26</span>, <span class="number">26</span>, <span class="number">26</span>),(<span class="number">27</span>, <span class="number">27</span>, <span class="number">27</span>),(<span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>),(<span class="number">29</span>, <span class="number">29</span>, <span class="number">29</span>),(<span class="number">30</span>, <span class="number">30</span>, <span class="number">30</span>),(<span class="number">31</span>, <span class="number">31</span>, <span class="number">31</span>),(<span class="number">32</span>, <span class="number">32</span>, <span class="number">32</span>),(<span class="number">33</span>, <span class="number">33</span>, <span class="number">33</span>),(<span class="number">34</span>, <span class="number">34</span>, <span class="number">34</span>),(<span class="number">35</span>, <span class="number">35</span>, <span class="number">35</span>),(<span class="number">36</span>, <span class="number">36</span>, <span class="number">36</span>),(<span class="number">37</span>, <span class="number">37</span>, <span class="number">37</span>),(<span class="number">38</span>, <span class="number">38</span>, <span class="number">38</span>),(<span class="number">39</span>, <span class="number">39</span>, <span class="number">39</span>),(<span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>),(<span class="number">41</span>, <span class="number">41</span>, <span class="number">41</span>),(<span class="number">42</span>, <span class="number">42</span>, <span class="number">42</span>),(<span class="number">43</span>, <span class="number">43</span>, <span class="number">43</span>),(<span class="number">44</span>, <span class="number">44</span>, <span class="number">44</span>),(<span class="number">45</span>, <span class="number">45</span>, <span class="number">45</span>),(<span class="number">46</span>, <span class="number">46</span>, <span class="number">46</span>),(<span class="number">47</span>, <span class="number">47</span>, <span class="number">47</span>),(<span class="number">48</span>, <span class="number">48</span>, <span class="number">48</span>),(<span class="number">49</span>, <span class="number">49</span>, <span class="number">49</span>),(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>),(<span class="number">51</span>, <span class="number">51</span>, <span class="number">51</span>),(<span class="number">52</span>, <span class="number">52</span>, <span class="number">52</span>),(<span class="number">53</span>, <span class="number">53</span>, <span class="number">53</span>),(<span class="number">54</span>, <span class="number">54</span>, <span class="number">54</span>),(<span class="number">55</span>, <span class="number">55</span>, <span class="number">55</span>),(<span class="number">56</span>, <span class="number">56</span>, <span class="number">56</span>),(<span class="number">57</span>, <span class="number">57</span>, <span class="number">57</span>),(<span class="number">58</span>, <span class="number">58</span>, <span class="number">58</span>),(<span class="number">59</span>, <span class="number">59</span>, <span class="number">59</span>),(<span class="number">60</span>, <span class="number">60</span>, <span class="number">60</span>),(<span class="number">61</span>, <span class="number">61</span>, <span class="number">61</span>),(<span class="number">62</span>, <span class="number">62</span>, <span class="number">62</span>),(<span class="number">63</span>, <span class="number">63</span>, <span class="number">63</span>),(<span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>),(<span class="number">65</span>, <span class="number">65</span>, <span class="number">65</span>),(<span class="number">66</span>, <span class="number">66</span>, <span class="number">66</span>),(<span class="number">67</span>, <span class="number">67</span>, <span class="number">67</span>),(<span class="number">68</span>, <span class="number">68</span>, <span class="number">68</span>),(<span class="number">69</span>, <span class="number">69</span>, <span class="number">69</span>),(<span class="number">70</span>, <span class="number">70</span>, <span class="number">70</span>),(<span class="number">71</span>, <span class="number">71</span>, <span class="number">71</span>),(<span class="number">72</span>, <span class="number">72</span>, <span class="number">72</span>),(<span class="number">73</span>, <span class="number">73</span>, <span class="number">73</span>),(<span class="number">74</span>, <span class="number">74</span>, <span class="number">74</span>),(<span class="number">75</span>, <span class="number">75</span>, <span class="number">75</span>),(<span class="number">76</span>, <span class="number">76</span>, <span class="number">76</span>),(<span class="number">77</span>, <span class="number">77</span>, <span class="number">77</span>),(<span class="number">78</span>, <span class="number">78</span>, <span class="number">78</span>),(<span class="number">79</span>, <span class="number">79</span>, <span class="number">79</span>),(<span class="number">80</span>, <span class="number">80</span>, <span class="number">80</span>),(<span class="number">81</span>, <span class="number">81</span>, <span class="number">81</span>),(<span class="number">82</span>, <span class="number">82</span>, <span class="number">82</span>),(<span class="number">83</span>, <span class="number">83</span>, <span class="number">83</span>),(<span class="number">84</span>, <span class="number">84</span>, <span class="number">84</span>),(<span class="number">85</span>, <span class="number">85</span>, <span class="number">85</span>),(<span class="number">86</span>, <span class="number">86</span>, <span class="number">86</span>),(<span class="number">87</span>, <span class="number">87</span>, <span class="number">87</span>),(<span class="number">88</span>, <span class="number">88</span>, <span class="number">88</span>),(<span class="number">89</span>, <span class="number">89</span>, <span class="number">89</span>),(<span class="number">90</span>, <span class="number">90</span>, <span class="number">90</span>),(<span class="number">91</span>, <span class="number">91</span>, <span class="number">91</span>),(<span class="number">92</span>, <span class="number">92</span>, <span class="number">92</span>),(<span class="number">93</span>, <span class="number">93</span>, <span class="number">93</span>),(<span class="number">94</span>, <span class="number">94</span>, <span class="number">94</span>),(<span class="number">95</span>, <span class="number">95</span>, <span class="number">95</span>),(<span class="number">96</span>, <span class="number">96</span>, <span class="number">96</span>),(<span class="number">97</span>, <span class="number">97</span>, <span class="number">97</span>),(<span class="number">98</span>, <span class="number">98</span>, <span class="number">98</span>),(<span class="number">99</span>, <span class="number">99</span>, <span class="number">99</span>),(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>위 쿼리는 <code>hibernate.jdbc.batch_size: 100</code>으로 지정한 결과입니다. 그렇다면 왜 <code>batch_size</code> 옵션을 주어서 한 번에 insert 할 수 있는 데이터의 크기를 제한하는 것일까요? 아래 코드에서 해답을 찾을 수 있습니다.</p>
<blockquote>
<p><a href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-jdbcbatch" rel="external nofollow noopener noreferrer" target="_blank">Hibernate User Guide: 12.2.1. Batch inserts</a></p>
<p>When you make new objects persistent, employ methods flush() and clear() to the session regularly, to control the size of the first-level cache.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">EntityManager entityManager = <span class="keyword">null</span>;</span><br><span class="line">EntityTransaction txn = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	entityManager = entityManagerFactory().createEntityManager();</span><br><span class="line"></span><br><span class="line">	txn = entityManager.getTransaction();</span><br><span class="line">	txn.begin();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> batchSize = <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entityCount; i++ ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( i &gt; <span class="number">0</span> &amp;&amp; i % batchSize == <span class="number">0</span> ) &#123;</span><br><span class="line">			<span class="comment">//flush a batch of inserts and release memory</span></span><br><span class="line">			entityManager.flush();</span><br><span class="line">			entityManager.clear();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Person Person = <span class="keyword">new</span> Person( String.format( <span class="string">"Person %d"</span>, i ) );</span><br><span class="line">		entityManager.persist( Person );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	txn.commit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">	<span class="keyword">if</span> ( txn != <span class="keyword">null</span> &amp;&amp; txn.isActive()) txn.rollback();</span><br><span class="line">		<span class="keyword">throw</span> e;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (entityManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">		entityManager.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>하이버네이트 공식 가이드의 내용입니다. <code>batchSize</code> 값을 기준으로 <code>flush();</code>, <code>clear();</code>를 이용해서 영속성 컨텍스트를 초기화 작업을 진행하고 있습니다. <code>batchSize</code>에 대한 제한이 없으면 영속성 컨텍스트에 모든 엔티티가 올라가기 때문에 <code>OutOfMemoryException</code> 발생할 수 있고, 메모리 관리 측면에서도 효율적이지 않기 때문입니다. 하이버네이트의 공식 가이드에서도 해당 부분의 언급이 있습니다.</p>
<blockquote>
<p><a href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-session-batch" rel="external nofollow noopener noreferrer" target="_blank">Hibernate User Guide: 12.2. Session batching</a></p>
<ol>
<li>Hibernate caches all the newly inserted Customer instances in the session-level cache, so, when the transaction ends, 100 000 entities are managed by the persistence context. If the maximum memory allocated to the JVM is rather low, this example could fail with an OutOfMemoryException. The Java 1.8 JVM allocated either 1/4 of available RAM or 1Gb, which can easily accommodate 100 000 objects on the heap.</li>
<li>long-running transactions can deplete a connection pool so other transactions don’t get a chance to proceed</li>
<li>JDBC batching is not enabled by default, so every insert statement requires a database roundtrip. To enable JDBC batching, set the hibernate.jdbc.batch_size property to an integer between 10 and 50.</li>
</ol>
</blockquote>
<h3><span id="쓰기-지연-sql-제약-사항">쓰기 지연 SQL 제약 사항</span></h3>
<p><code>batchSize: 50</code> 경우 <code>PaymentBackJpa</code> 객체를 50 단위로 Batch Insert 쿼리가 실행되지만, 중간에 다른 엔티티를 저장하는 경우 아래처럼 지금까지의 <code>PaymentBackJpa</code>에 대한 지정하기 때문에 최종적으로 <code>batchSize: 50</code> 단위로 저장되지 않습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">em.persist(<span class="keyword">new</span> PaymentBackJpa()); <span class="comment">// 1</span></span><br><span class="line">em.persist(<span class="keyword">new</span> PaymentBackJpa()); <span class="comment">// 2</span></span><br><span class="line">em.persist(<span class="keyword">new</span> PaymentBackJpa()); <span class="comment">// 3</span></span><br><span class="line">em.persist(<span class="keyword">new</span> PaymentBackJpa()); <span class="comment">// 4</span></span><br><span class="line">em.persist(<span class="keyword">new</span> Orders()); <span class="comment">// 1-1, 다른 SQL이 추가 되었기 때문에  SQL 배치를 다시 시작 해야 한다.</span></span><br><span class="line">em.persist(<span class="keyword">new</span> PaymentBackJpa()); <span class="comment">// 1</span></span><br><span class="line">em.persist(<span class="keyword">new</span> PaymentBackJpa()); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
<p>이러한 문제는 <code>hibernate.order_updates: true</code>, <code>hibernate.order_inserts: true</code> 값으로 해결 할 수 있습니다.</p>
<h3><span id="jpa-batch-insert의-가장-큰-문제">JPA Batch Insert의 가장 큰 문제…</span></h3>
<p>위에서 설명했던 부분들은 Batch Insert에 필요한 properties 설정, 그리고 내부적으로 JPA에서 Batch Insert에 대한 동작 방식을 설명한 것입니다. <strong>실제 Batch Insert를 진행하는 코드는 별다른 부분이 없고 컬렉션 객체를 <code>saveAll()</code> 메서드로 호출하는 것이 전부입니다.</strong> 이로써 JPA는 Batch Insert를 강력하게 지원해 주고 있습니다. <strong>하지만 가장 큰 문제가 있습니다. <code>@GeneratedValue(strategy = GenerationType.IDENTITY)</code> 방식의 경우 Batch Insert를 지원하지 않습니다.</strong></p>
<blockquote>
<p><a href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-session-batch" rel="external nofollow noopener noreferrer" target="_blank">Hibernate User Guide: 12.2. Session batching</a></p>
<p>Hibernate disables insert batching at the JDBC level transparently if you use an identity identifier generator.</p>
</blockquote>
<p>공식 문서에도 언급이 있듯이 <code>@GeneratedValue(strategy = GenerationType.IDENTITY)</code> 경우 Batch Insert를 지원하지 않습니다. 정확히 어떤 이유 때문인지에 대해서는 언급이 없고, 관련 내용을 잘 설명한 <a href="https://stackoverflow.com/questions/27697810/why-does-hibernate-disable-insert-batching-when-using-an-identity-identifier-gen/27732138#27732138" rel="external nofollow noopener noreferrer" target="_blank">StackOverflow</a>를 첨부합니다.</p>
<p>제가 이해한 바로는 하이버네이트는 <code>Transactional Write Behind</code> 방식(마지막까지 영속성 컨텍스트에서 데이터를 가지고 있어 플러시를 연기하는 방식)을 사용하기 때문에 <code>GenerationType.IDENTITY</code> 방식의 경우 JDBC Batch Insert를 비활성화함. <code>GenerationType.IDENTITY</code> 방식이란 <code>auto_increment</code>으로 PK 값을 자동으로 증분 해서 생성하는 것으로 매우 효율적으로 관리할 수 있다.(heavyweight transactional course-grain locks 보다 효율적). 하지만 Insert를 실행하기 전까지는 ID에 할당된 값을 알 수 없기 때문에 <code>Transactional Write Behind</code>을 할 수 없고 결과적으로 Batch Insert를 진행할 수 없다.</p>
<p>Mysql에서는 대부분 <code>GenerationType.IDENTITY</code>으로 사용하기 때문에 해당 문제는 치명적입니다. 우선 <code>GenerationType.IDENTITY</code> 으로 지정하고 다시 테스트 코드를 돌려 보겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = <span class="meta-string">"payment_back"</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentBackJpa</span></span>(</span><br><span class="line">    <span class="meta">@Column(name = <span class="meta-string">"amount"</span>, nullable = false)</span></span><br><span class="line">    <span class="keyword">var</span> amount: BigDecimal,</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = <span class="meta-string">"order_id"</span>, nullable = false, updatable = false)</span></span><br><span class="line">    <span class="keyword">val</span> orderId: <span class="built_in">Long</span></span><br><span class="line">)&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span> <span class="comment">// GenerationType.IDENTITY 지정</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Long</span>? = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">BulkInsertJobConfigurationTest</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paymentBackJpaRepository: PaymentBackJpaRepository</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `jpa 기반 bulk insert`<span class="params">()</span></span> &#123;</span><br><span class="line">        (<span class="number">1.</span><span class="number">.100</span>).map &#123;</span><br><span class="line">            PaymentBackJpa(</span><br><span class="line">                amount = it.toBigDecimal(),</span><br><span class="line">                orderId = it.toLong()</span><br><span class="line">            )</span><br><span class="line">                .apply &#123;</span><br><span class="line"><span class="comment">//                    this.id = it.toLong() // ID를 자동 증가로 변경 했기 때문에 코드 주석</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;.also &#123;</span><br><span class="line">            paymentBackJpaRepository.saveAll(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Query	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">6</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">7</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">8</span>, <span class="number">8</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">9</span>, <span class="number">9</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">11</span>, <span class="number">11</span>)</span><br><span class="line"><span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> payment_back (amount, order_id) <span class="keyword">values</span> (<span class="number">12</span>, <span class="number">12</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong><code>GenerationType.IDENTITY</code>의 경우에는 Batch Insert가 진행되지 않습니다.</strong> 그래서 다른 대안을 찾아야 했습니다. 이 부분부터는 다음 포스팅에서 이어가겠습니다.</p>
<h2><span id="참고">참고</span></h2>
<ul>
<li><a href="https://homoefficio.github.io/2020/01/25/Spring-Data%EC%97%90%EC%84%9C-Batch-Insert-%EC%B5%9C%EC%A0%81%ED%99%94/" rel="external nofollow noopener noreferrer" target="_blank">Spring Data에서 Batch Insert 최적화</a></li>
<li><a href="https://github.com/HomoEfficio/dev-tips/blob/master/JPA-GenerationType-%EB%B3%84-INSERT-%EC%84%B1%EB%8A%A5-%EB%B9%84%EA%B5%90.md" rel="external nofollow noopener noreferrer" target="_blank">JPA GenerationType에 따른 INSERT 성능 차이</a></li>
<li><a href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-session-batch-insert" rel="external nofollow noopener noreferrer" target="_blank">JPA Batch inserts Document</a></li>
<li><a href="https://vladmihalcea.com/jpa-persist-and-merge/" rel="external nofollow noopener noreferrer" target="_blank">How do persist and merge work in JPA</a></li>
<li><a href="https://dev.mysql.com/doc/connector-j/8.0/en/" rel="external nofollow noopener noreferrer" target="_blank">MySQL Connector/J 8.0 Developer Guide</a></li>
<li><a href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html" rel="external nofollow noopener noreferrer" target="_blank">Hibernate ORM 5.4.28.Final User Guide</a></li>
<li><a href="http://www.acornpub.co.kr/book/jpa-programmig" rel="external nofollow noopener noreferrer" target="_blank">자바 ORM 표준 JPA 프로그래밍</a></li>
</ul>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/spring-batch-batch-insert/" data-toggle="tooltip" data-placement="top" title="Batch Insert 성능 향상기 2편 - 성능 측정">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/spring-batch-test-2/" data-toggle="tooltip" data-placement="top" title="Spring Batch Test 작성 방법 및 고찰">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Batch Insert 란 ?</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Batch Insert With JPA</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">쓰기 지연 SQL 지원 이란 ?</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">JPA With Batch Insert Code</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">batch size</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">쓰기 지연 SQL 제약 사항</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.5.</span> <span class="toc-nav-text">JPA Batch Insert의 가장 큰 문제…</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">참고</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#JPA" title="JPA">JPA</a>
                        
                          <a class="tag" href="/tags/#Batch Insert" title="Batch Insert">Batch Insert</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>



<!-- Comment -->
<!--  utteranc comment -->

<script src="https://utteranc.es/client.js" repo="cheese10yun/blog-comment" issue-term="title" label="Comment" theme="github-light" crossorigin="anonymous" async>
</script>






<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                

                

                

                
                    <li>
                        <a target="_blank" href="https://github.com/cheese10yun" rel="external nofollow noopener noreferrer">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Yun 2021 
                    <br>
                    Theme by <a href="http://huangxuan.me" rel="external nofollow noopener noreferrer" target="_blank">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://beantech.org" rel="external nofollow noopener noreferrer" target="_blank">BeanTech</a> | 
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=YenYuHsuan&repo=hexo-theme-beantech&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://cheese10yun.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-90907312-1';
    var _gaDomain = 'https://cheese10yun.github.io/';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->



	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async></script>
<!-- Image to hack wechat -->
<img src="https://cheese10yun.github.io/img/icon_wechat.png" width="0" height="0">
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
